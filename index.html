<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emotion Detection</title>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    overflow: hidden;
    background: #f0f0f0;
}

/* ===== Emoji Background ===== */
.emoji-bg {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
    overflow: hidden;
}

.emoji {
    position: absolute;
    font-size: 32px;
    opacity: 0.15;
    animation: float 20s linear infinite;
}

@keyframes float {
    from { transform: translateY(100vh) rotate(0deg); }
    to   { transform: translateY(-120vh) rotate(360deg); }
}

/* ===== Main UI ===== */
#status {
    margin-bottom: 15px;
    padding: 10px;
    background: #333;
    color: #fff;
    border-radius: 4px;
    display: inline-block;
    position: relative;
    z-index: 2;
}

.container {
    position: relative;
    z-index: 2;
    display: inline-block;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

canvas {
    border: 2px solid #333;
}
</style>

<script>
/* ===== Emoji Background Logic ===== */
const emojis = ["üòÄ","üò°","üò±","üò¢","üòê","üòç","ü§¢","üòÆ"];

function createEmoji() {
    const emoji = document.createElement("div");
    emoji.className = "emoji";
    emoji.innerText = emojis[Math.floor(Math.random() * emojis.length)];

    emoji.style.left = Math.random() * 100 + "vw";
    emoji.style.fontSize = (24 + Math.random() * 32) + "px";
    emoji.style.animationDuration = (15 + Math.random() * 20) + "s";

    document.querySelector(".emoji-bg").appendChild(emoji);

    setTimeout(() => emoji.remove(), 35000);
}

setInterval(createEmoji, 600);

/* ===== Emotion Detection (‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ===== */
let session;
let faceCascade;
const labels = ["Angry","Disgust","Fear","Happy","Sad","Surprise","Neutral"];

async function onOpenCvReady() {
    const status = document.getElementById('status');
    status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...";
    session = await ort.InferenceSession.create('./emotion_yolo11n_cls.onnx');

    faceCascade = new cv.CascadeClassifier();
    const xml = 'haarcascade_frontalface_default.xml';
    const res = await fetch(xml);
    cv.FS_createDataFile("/", xml, new Uint8Array(await res.arrayBuffer()), true, false);
    faceCascade.load(xml);

    status.innerText = "‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    startVideo();
}

function startVideo() {
    const video = document.getElementById('videoInput');
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => processVideo();
    });
}

async function processVideo() {
    const video = document.getElementById('videoInput');
    const canvas = document.getElementById('canvasOutput');
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    let src = cv.imread(canvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    let faces = new cv.RectVector();
    faceCascade.detectMultiScale(gray, faces, 1.1, 3);

    for (let i = 0; i < faces.size(); i++) {
        let f = faces.get(i);
        ctx.strokeStyle = "#00ff00";
        ctx.strokeRect(f.x, f.y, f.width, f.height);
    }

    src.delete(); gray.delete(); faces.delete();
    requestAnimationFrame(processVideo);
}
</script>

<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
</head>

<body>
<div class="emoji-bg"></div>

<div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>

<div class="container">
    <video id="videoInput" width="640" height="480" autoplay playsinline style="display:none"></video>
    <canvas id="canvasOutput" width="640" height="480"></canvas>
</div>

</body>
</html>
